<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>CVE-2022-32932: ZinComputeProgramUpdateMutables() OOB write due to double fetch issue | 0x36.github.io</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="CVE-2022-32932: ZinComputeProgramUpdateMutables() OOB write due to double fetch issue" />
<meta name="author" content="Mohamed GHANNAM (@_simo36)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Analysis:" />
<meta property="og:description" content="Analysis:" />
<link rel="canonical" href="http://localhost:4000/CVE-2022-32932/" />
<meta property="og:url" content="http://localhost:4000/CVE-2022-32932/" />
<meta property="og:site_name" content="0x36.github.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-11-15T00:00:00+04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CVE-2022-32932: ZinComputeProgramUpdateMutables() OOB write due to double fetch issue" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Mohamed GHANNAM (@_simo36)"},"dateModified":"2022-11-15T00:00:00+04:00","datePublished":"2022-11-15T00:00:00+04:00","description":"Analysis:","headline":"CVE-2022-32932: ZinComputeProgramUpdateMutables() OOB write due to double fetch issue","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/CVE-2022-32932/"},"url":"http://localhost:4000/CVE-2022-32932/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="0x36.github.io" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">0x36.github.io</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">CVE-2022-32932: ZinComputeProgramUpdateMutables() OOB write due to double fetch issue</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-11-15T00:00:00+04:00" itemprop="datePublished">Nov 15, 2022
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Mohamed GHANNAM (@_simo36)</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="analysis">Analysis:</h2>

<hr />
<p><code class="language-plaintext highlighter-rouge">H11ANEIn::patchMutableSurface()</code> (reachable from <code class="language-plaintext highlighter-rouge">H11ANEIn::ANE_ProgramSendRequest_gated</code>) is called if the <code class="language-plaintext highlighter-rouge">model.hwx</code> has a mutable procedure and has also <em>initInfo</em> section, I looked for such a model but couldn’t find any, so I ended up patching one of the pre-compiled models and used CVE-2022-32845 to load it. Please keep in mind that CVE-2022-32845 is not required to reach the vulnerable code path from the default app sandbox, it is sufficient to compile a custom mlmodel to achieve the same results.
You can find more details about CVE-2022-32845 in my <a href="https://github.com/0x36/weightBufs/blob/main/attacking_ane_poc2022.pdf">presentation slides</a>.</p>

<p><code class="language-plaintext highlighter-rouge">ZinComputeProgramUpdateMutables()</code> is another function that’s called by <code class="language-plaintext highlighter-rouge">H11ANEIn::patchMutableSurface()</code> and the function prototype is the following:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ZinComputeProgramStatus</span> <span class="kr">__cdecl</span> <span class="nf">ZinComputeProgramUpdateMutables</span><span class="p">(</span>
        <span class="kt">uint64_t</span> <span class="n">procedureId</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">ZinComputeProgramInitInfo</span> <span class="o">*</span><span class="n">init_info</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">ANECMutableProcedureInfo</span> <span class="o">*</span><span class="n">mutable_procedure_info</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">mut_procedure_info_size</span><span class="p">,</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">MUTK_kernel_section</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">MUTK_kernel_section_size</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li><strong>init_info</strong>: is the <code class="language-plaintext highlighter-rouge">initInfo</code> section that contains a serialized input, you can find the serializer function <a href="https://github.com/0x36/weightBufs/blob/main/exploit/exploit.m#L644">serialize_initinfo_section()</a> in <code class="language-plaintext highlighter-rouge">weightBufs</code> exploit source code.</li>
  <li><strong>mutable_procedure_info</strong> : is a shared IOSurface buffer provided by the attacker, it’s also called <strong>weightsBuffer</strong> in <code class="language-plaintext highlighter-rouge">weightBufs</code> exploit.</li>
  <li><strong>mut_procedure_info_size</strong>: It denotes the size of the <strong>mutable_procedure_info</strong> surface buffer.</li>
  <li><strong>MUTK_kernel_section</strong>: (or <code class="language-plaintext highlighter-rouge">MUTK</code>) It’s a mapping buffer of an IOSurface object that’s created by the kernel during program loading phase.</li>
  <li><strong>MUTK_kernel_section_size</strong>:  is the size of the mutable kernel section.</li>
</ul>

<p><img src="/img/double_fetch/image1.png" alt="Untitled" /></p>

<p>The loop <strong>88-92</strong> calculates the <code class="language-plaintext highlighter-rouge">MutableWeight</code> object count within the <strong>mutable_procedure_info</strong> object, then calculates the allocation size of the <code class="language-plaintext highlighter-rouge">MutableWeight</code> array at <strong>93</strong>. 
After that, the <code class="language-plaintext highlighter-rouge">ANECMutableWeight</code> array of objects is allocated at <strong>100</strong>, then populated with the appropriate weight buffer/size pair in the loop <strong>111-127</strong> by <code class="language-plaintext highlighter-rouge">ANECGetMutableWeight()</code>.</p>

<p><code class="language-plaintext highlighter-rouge">ANECGetMutableOperationInfo()</code> returns an object <code class="language-plaintext highlighter-rouge">opsInfo</code> from our shared memory:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">opsInfo</span> <span class="o">*</span><span class="kr">__fastcall</span> <span class="nf">ANECGetMutableOperationInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">ANECMutableProcedureInfo</span> <span class="o">*</span><span class="n">MutableProcedureInfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">weight_buffer_size</span><span class="p">;</span> <span class="c1">// w8</span>
  <span class="n">opsInfo</span> <span class="o">*</span><span class="n">opInfo</span><span class="p">;</span> <span class="c1">// x0</span>

  <span class="n">weight_buffer_size</span> <span class="o">=</span> <span class="n">MutableProcedureInfo</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">weight_buffer_size</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">weight_buffer_size</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">opInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">opsInfo</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">MutableProcedureInfo</span> <span class="o">+</span> <span class="n">MutableProcedureInfo</span><span class="o">-&gt;</span><span class="n">wb_offsets</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">opInfo</span><span class="o">-&gt;</span><span class="n">op_index</span> <span class="o">!=</span> <span class="n">id</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!--</span><span class="n">weight_buffer_size</span> <span class="p">)</span>
      <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">opInfo</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">ANECGetMutableWeight</code> pseudo-code is the following:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="nf">ANECGetMutableWeight</span><span class="p">(</span>
        <span class="k">const</span> <span class="n">ANECMutableProcedureInfo</span> <span class="o">*</span><span class="n">procedure_info</span><span class="p">,</span>
        <span class="n">weightInfo</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span>
        <span class="n">ANECMutableWeight</span> <span class="o">*</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">uint64_t</span> <span class="n">wi_size</span><span class="p">;</span> <span class="c1">// x9</span>

  <span class="n">wi_size</span> <span class="o">=</span> <span class="n">a2</span><span class="o">-&gt;</span><span class="n">wi_size</span><span class="p">;</span>
  <span class="n">a3</span><span class="o">-&gt;</span><span class="n">_weightBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">procedure_info</span> <span class="o">+</span> <span class="n">a2</span><span class="o">-&gt;</span><span class="n">wi_off</span><span class="p">;</span>
  <span class="n">a3</span><span class="o">-&gt;</span><span class="n">_weightBufSize</span> <span class="o">=</span> <span class="n">wi_size</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">ANECGetMutableWeightInfo</code> pseudo-code is the following:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">weightInfo</span> <span class="o">*</span><span class="kr">__fastcall</span> <span class="nf">ANECGetMutableWeightInfo</span><span class="p">(</span>
        <span class="k">const</span> <span class="n">ANECMutableProcedureInfo</span> <span class="o">*</span><span class="n">MutableProcedureInfo</span><span class="p">,</span>
        <span class="n">opsInfo</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">a2</span><span class="o">-&gt;</span><span class="n">op_count</span> <span class="o">&lt;=</span> <span class="n">a3</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">weightInfo</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">MutableProcedureInfo</span> <span class="o">+</span> <span class="n">a2</span><span class="o">-&gt;</span><span class="n">op_offsets</span><span class="p">[</span><span class="n">a3</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>I already described the format of the <code class="language-plaintext highlighter-rouge">ANECMutableProcedureInfo</code> in <a href="https://github.com/0x36/weightBufs/blob/main/attacking_ane_poc2022.pdf">“Attacking Apple’s Neural Engine” slides</a>, so feel free to read it if you haven’t already. The structure definition can be found in weightBufs exploit at <a href="https://github.com/0x36/weightBufs/blob/main/exploit/aneProgram.h#L190">‘aneProgram.h’</a>.</p>

<h2 id="vulnerability">Vulnerability:</h2>
<hr />

<p>If you’ve noticed, <code class="language-plaintext highlighter-rouge">ANECGetMutableOperationInfo()-&gt;op_count</code> is fetched twice: once to calculate the size in order to allocate the <code class="language-plaintext highlighter-rouge">ANECMutableWeight</code> array, and once to populate this array.</p>

<p>Because the <strong>mutable_procedure_info</strong> buffer is a shared memory, an attacker <strong>could use a separate thread to change the value of <code class="language-plaintext highlighter-rouge">opsInfo-&gt;op_count</code> between the first and the second usages</strong>, resulting in a size mismatch that will lead to an interesting OOB write in either a kalloc var zone, kheap defaul or the kernel map.</p>

<p>The vulnerability can be used in many interesting ways. For example, an attacker could set <code class="language-plaintext highlighter-rouge">total_count = 0x1000;</code> at line <strong>93</strong>, then increase <code class="language-plaintext highlighter-rouge">opsInfo-&gt;count</code> to something larger, causing data to be copied out of bounds at <code class="language-plaintext highlighter-rouge">ANECGetMutableWeight()</code> .</p>

<p>The kernel will panic at the instruction shown below if the OOB write has reached an unmapped memory area:</p>

<pre><code class="language-txt">com.apple.driver.AppleH11ANEInterface:__text:FFFFFE0008913D08                 EXPORT _ANECGetMutableWeight
com.apple.driver.AppleH11ANEInterface:__text:FFFFFE0008913D08 _ANECGetMutableWeight                   ; CODE XREF: _ZinComputeProgramUpdateMutables+270↓p
com.apple.driver.AppleH11ANEInterface:__text:FFFFFE0008913D08                 LDP             X8, X9, [X1,#8]
com.apple.driver.AppleH11ANEInterface:__text:FFFFFE0008913D0C                 ADD             X8, X0, X8
com.apple.driver.AppleH11ANEInterface:__text:FFFFFE0008913D10                 STP             X8, X9, [X2] // &lt;---- Kernel panic 
com.apple.driver.AppleH11ANEInterface:__text:FFFFFE0008913D14                 RET
</code></pre>

<p>This bug provides a strong primitive in that it writes two 64-bit values: a kernel address pointing to our user shared buffer and a (semi-)arbitrary 64-bit value.</p>

<h2 id="proof-of-concept">Proof-Of-Concept:</h2>
<p>The proof-of-concept is left as an exercise for the reader. However, <code class="language-plaintext highlighter-rouge">weightBufs</code> exploit includes everything required to reach the vulnerable code path. Good Luck :-).</p>

  </div><a class="u-url" href="/CVE-2022-32932/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">0x36.github.io</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">0x36.github.io</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://www.twitter.com/_simo36"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">_simo36</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
